---
import Layout from "../../layouts/Layout.astro";
import { ProductCard } from "../../components/shop/ProductCard";
import { db } from "../../db";
import { productos, rifas } from "../../db/schema";
import { Card } from "../../components/common/Card";
import { Button } from "../../components/common/Button";
import { addToCart } from "../../store/cart";

// Fetch products and raffles
const productsList = await db.select().from(productos);
const rafflesList = await db.select().from(rifas);

// Separate products by category if needed, or just list all
const clothing = productsList.filter((p) => p.categoria !== "accesorio");
const accessories = productsList.filter((p) => p.categoria === "accesorio");
---

<Layout title="Tienda - La Banda a Jujuy">
    <div class="bg-brand-orange py-12 mb-8">
        <div class="container mx-auto px-4 text-center text-white">
            <h1 class="text-4xl font-bold mb-4">Tienda Solidaria</h1>
            <p class="text-xl max-w-2xl mx-auto opacity-90">
                Llevate un recuerdo y colabor√° con el equipo. Todo lo recaudado
                va directamente al fondo del viaje.
            </p>
        </div>
    </div>

    <div class="container mx-auto px-4 pb-20 space-y-16">
        {/* Rifas Section */}
        <section id="rifas" class="scroll-mt-24">
            <div class="flex items-center gap-4 mb-8">
                <div class="h-1 bg-gray-200 flex-grow rounded-full"></div>
                <h2 class="text-3xl font-bold text-center text-brand-dark">
                    Rifas Activas
                </h2>
                <div class="h-1 bg-gray-200 flex-grow rounded-full"></div>
            </div>

            {
                rafflesList.length > 0 ? (
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        {rafflesList.map((raffle) => (
                            <Card
                                className="flex flex-col md:flex-row overflow-hidden border-2 border-brand-orange/20"
                                hoverEffect
                            >
                                <div class="bg-brand-orange/10 p-8 flex items-center justify-center md:w-1/3">
                                    <div class="text-6xl">üéüÔ∏è</div>
                                </div>
                                <div class="p-6 flex-1 flex flex-col">
                                    <h3 class="text-2xl font-bold mb-2">
                                        {raffle.premio}
                                    </h3>
                                    <div class="mb-4 space-y-1 text-gray-600">
                                        <p>
                                            üìÖ Sortea:{" "}
                                            {raffle.fechaSorteo ||
                                                "A confirmar"}
                                        </p>
                                        <p className="text-brand-orange font-bold text-lg">
                                            {" "}
                                            Valor: ${raffle.precioNumero}
                                        </p>
                                    </div>
                                    <div class="mt-auto">
                                        <Button
                                            fullWidth
                                            className="shadow-md"
                                            client:load
                                            onClick={() =>
                                                addToCart({
                                                    id: 1000 + raffle.id, // Offset ID to avoid collision with products
                                                    name: `Rifa: ${raffle.premio}`,
                                                    price: raffle.precioNumero,
                                                    category: "rifa",
                                                })
                                            }
                                        >
                                            Comprar N√∫mero
                                        </Button>
                                    </div>
                                </div>
                            </Card>
                        ))}
                    </div>
                ) : (
                    <div class="text-center py-12 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
                        <p class="text-gray-500 text-lg">
                            No hay rifas activas en este momento.
                        </p>
                    </div>
                )
            }
        </section>

        {/* Products Section */}
        <section>
            <div class="flex items-center gap-4 mb-8">
                <div class="h-1 bg-gray-200 flex-grow rounded-full"></div>
                <h2 class="text-3xl font-bold text-center text-brand-dark">
                    Productos
                </h2>
                <div class="h-1 bg-gray-200 flex-grow rounded-full"></div>
            </div>

            {
                productsList.length > 0 ? (
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                        {productsList.map((product) => (
                            <ProductCard client:load product={product} />
                        ))}
                    </div>
                ) : (
                    <div class="text-center py-12 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
                        <p class="text-gray-500 text-lg">
                            Pr√≥ximamente estaremos cargando productos.
                        </p>
                    </div>
                )
            }
        </section>
    </div>
</Layout>
